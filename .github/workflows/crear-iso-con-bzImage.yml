name: Crear ISO con bzImage existente

on:
  workflow_dispatch:

jobs:
  iso-from-bzimage:
    runs-on: ubuntu-latest

    steps:
    - name: Clonar CultraCore
      uses: actions/checkout@v3

    - name: Instalar dependencias
      run: |
        sudo apt update
        sudo apt install build-essential genisoimage gcc curl dpkg

    - name: Compilar init, shell y bootanim
      run: |
        mkdir -p system/bin
        gcc src/init.c -o system/bin/init
        gcc src/shell.c -o system/bin/shell
        gcc src/bootanim.c -o system/bin/bootanim

    - name: Crear estructura ISO
      run: |
        mkdir -p iso_root/boot
        mkdir -p iso_root/bin
        cp system/boot/bzImage iso_root/boot/
        cp system/bin/* iso_root/bin/
        echo "DEFAULT cultracore\nLABEL cultracore\n  KERNEL /boot/bzImage\n  APPEND init=/bin/init" > iso_root/isolinux.cfg

    - name: Obtener isolinux.bin desde paquete Debian
      run: |
        mkdir -p isolinux
        curl -L --fail -o isolinux.deb https://ftp.debian.org/debian/pool/main/s/syslinux/isolinux_6.04~git20190206.bf6db5b4+dfsg1-3.2_all.deb
        dpkg-deb -x isolinux.deb isolinux/

        FOUND=$(find isolinux -name isolinux.bin | head -n 1)
        if [ -z "$FOUND" ]; then
          echo "❌ isolinux.bin no se encontró en el paquete."
          find isolinux -type f | head -n 20
          exit 1
        fi

        cp "$FOUND" iso_root/isolinux.bin
        echo "✅ isolinux.bin copiado a iso_root/"
        ls -lh iso_root/isolinux.bin

        genisoimage -o cultracore_x64.iso \
          -b isolinux.bin \
          -c boot.cat \
          -no-emul-boot -boot-load-size 4 -boot-info-table \
          -iso-level 3 -J -R iso_root

    - name: Validar ISO generado
      run: |
        echo "✅ ISO generado:"
        ls -lh cultracore_x64.iso

    - name: Subir artefacto ISO
      uses: actions/upload-artifact@v4
      with:
        name: CultraCore-x64-ISO
        path: cultracore_x64.iso
