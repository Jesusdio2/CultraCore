name: Crear ISO con bzImage existente

on:
  workflow_dispatch:

jobs:
  iso-from-bzimage:
    runs-on: ubuntu-latest

    steps:
    - name: Clonar CultraCore
      uses: actions/checkout@v3

    - name: Instalar dependencias
      run: |
        sudo apt update
        sudo apt install build-essential genisoimage gcc curl dpkg

    - name: Compilar init, shell y bootanim
      run: |
        mkdir -p system/bin
        gcc src/init.c -o system/bin/init
        gcc src/shell.c -o system/bin/shell
        gcc src/bootanim.c -o system/bin/bootanim

    - name: Generar initramfs
      run: |
        mkdir -p initramfs/bin
        cp system/bin/init initramfs/init
        cp system/bin/* initramfs/bin/
        chmod +x initramfs/init
        mkdir -p iso_root/boot
        cd initramfs
        echo "üì¶ Contenido antes de empaquetar:"
        find .
        echo "üîç Verificando permisos de /init:"
        ls -l init
        find . | cpio -H newc -o | gzip > ../iso_root/boot/initramfs.cpio.gz

    - name: Crear estructura ISO
      run: |
        mkdir -p iso_root/bin
        cp system/boot/bzImage iso_root/boot/
        cp system/bin/* iso_root/bin/
        printf "DEFAULT cultracore\nLABEL cultracore\n  KERNEL /boot/bzImage\n  APPEND initrd=/boot/initramfs.cpio.gz rdinit=/init\n" > iso_root/isolinux.cfg

    - name: Obtener isolinux.bin y ldlinux.c32 desde paquetes Debian
      run: |
        mkdir -p isolinux

        curl -L --fail -o isolinux.deb https://ftp.debian.org/debian/pool/main/s/syslinux/isolinux_6.04~git20190206.bf6db5b4+dfsg1-3.2_all.deb
        curl -L --fail -o syslinux-common.deb https://ftp.debian.org/debian/pool/main/s/syslinux/syslinux-common_6.04~git20190206.bf6db5b4+dfsg1-3.2_all.deb

        dpkg-deb -x isolinux.deb isolinux/
        dpkg-deb -x syslinux-common.deb isolinux/

        FOUND_BIN=$(find isolinux -name isolinux.bin | head -n 1)
        FOUND_LD=$(find isolinux -name ldlinux.c32 | head -n 1)

        if [ -z "$FOUND_BIN" ] || [ -z "$FOUND_LD" ]; then
          echo "‚ùå No se encontraron los archivos necesarios:"
          [ -z "$FOUND_BIN" ] && echo "  - isolinux.bin faltante"
          [ -z "$FOUND_LD" ] && echo "  - ldlinux.c32 faltante"
          find isolinux -type f | grep -E 'isolinux.bin|ldlinux.c32'
          exit 1
        fi

        cp "$FOUND_BIN" iso_root/isolinux.bin
        cp "$FOUND_LD" iso_root/ldlinux.c32

        echo "‚úÖ Archivos copiados a iso_root/"
        ls -lh iso_root/isolinux.bin iso_root/ldlinux.c32

        genisoimage -o cultracore_x64.iso \
          -b isolinux.bin \
          -c boot.cat \
          -no-emul-boot -boot-load-size 4 -boot-info-table \
          -iso-level 3 -J -R iso_root

    - name: Validar ISO generado
      run: |
        echo "‚úÖ ISO generado:"
        ls -lh cultracore_x64.iso

    - name: Subir artefacto ISO
      uses: actions/upload-artifact@v4
      with:
        name: CultraCore-x64-ISO
        path: cultracore_x64.iso
