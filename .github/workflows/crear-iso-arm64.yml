name: Build CultraCore ISO ARM64

on:
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-latest

    steps:
    - name: Clonar CultraCore
      uses: actions/checkout@v3

    - name: Instalar dependencias
      run: |
       sudo apt update
       sudo apt install -y build-essential gcc-aarch64-linux-gnu \
        genisoimage grub-common grub-pc-bin grub-efi-arm64-cross \
        libncurses-dev flex bison libssl-dev libelf-dev \
        cpio gzip curl busybox-static

    - name: Descargar kernel ARM64 (Image) desde Release
      run: |
        mkdir -p system/boot
        curl -L https://github.com/Jesusdio2/CultraCore/releases/download/Dev1/Image \
          -o system/boot/Image

    - name: Compilar binarios (init, shell, bootanim)
      run: |
        mkdir -p system/bin
        aarch64-linux-gnu-gcc -static src/init.c -o system/bin/init
        aarch64-linux-gnu-gcc -static src/shell.c -o system/bin/shell
        aarch64-linux-gnu-gcc -static src/bootanim.c -o system/bin/bootanim

    - name: Generar initramfs
      run: |
        mkdir -p initramfs/{bin,sbin,etc,proc,sys,dev}
        cp system/bin/init initramfs/bin/init
        cp system/bin/shell initramfs/bin/shell
        cp system/bin/bootanim initramfs/bin/bootanim
        chmod +x initramfs/bin/init

        cp /bin/busybox initramfs/bin/busybox
        ln -s /bin/busybox initramfs/bin/sh

        mkdir -p iso_root/boot
        (cd initramfs && find . | cpio -H newc -o) | gzip > iso_root/boot/initramfs.cpio.gz

    - name: Crear estructura ISO con GRUB EFI
      run: |
        mkdir -p iso_root/boot/grub
        cp system/boot/Image iso_root/boot/Image
        cat > iso_root/boot/grub/grub.cfg <<EOF
        set default=0
        set timeout=5
        menuentry "CultraCore ARM64" {
          linux /boot/Image initrd=/boot/initramfs.cpio.gz rdinit=/bin/init console=ttyAMA0
          initrd /boot/initramfs.cpio.gz
        }
        EOF

    - name: Crear imagen ISO ARM64
      run: |
        grub-mkrescue --output=cultracore_arm64.iso iso_root

    - name: Subir artefacto ISO
      uses: actions/upload-artifact@v4
      with:
        name: CultraCore-ARM64-ISO
        path: cultracore_arm64.iso
