name: Build CultraCore ISO ARM64

on:
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-latest

    steps:
    - name: Clonar CultraCore
      uses: actions/checkout@v3

    - name: Instalar dependencias
      run: |
        sudo apt update
        sudo apt install -y build-essential gcc-aarch64-linux-gnu \
          genisoimage grub2-common grub-pc-bin xorriso mtools \
          libncurses-dev flex bison libssl-dev libelf-dev \
          cpio gzip curl busybox-static libsdl2-dev

    - name: Descargar kernel ARM64 (Image) desde Release
      run: |
        mkdir -p system/boot
        curl -L https://github.com/Jesusdio2/CultraCore/releases/download/Dev1/Image \
          -o system/boot/Image

    - name: Compilar binarios (init, shell, bootanim, installer_gui)
      run: |
        mkdir -p system/bin
        aarch64-linux-gnu-gcc -static src/init.c -o system/bin/init
        aarch64-linux-gnu-gcc -static src/shell.c -o system/bin/shell
        # Compilar dinámico con SDL2 (más seguro en ARM64)
        aarch64-linux-gnu-gcc src/bootanim.c -o system/bin/bootanim -lSDL2
        aarch64-linux-gnu-gcc src/installer_gui.c -o system/bin/installer_gui -lSDL2

    - name: Generar initramfs
      run: |
        mkdir -p initramfs/{bin,sbin,etc,proc,sys,dev,lib}
        cp system/bin/init initramfs/init
        cp system/bin/shell initramfs/bin/shell
        cp system/bin/bootanim initramfs/bin/bootanim
        cp system/bin/installer_gui initramfs/bin/installer_gui
        chmod +x initramfs/init

        # Busybox básico
        cp /bin/busybox initramfs/bin/busybox
        ln -s busybox initramfs/sh

        # Copiar librerías dinámicas necesarias para SDL2
        ldd system/bin/bootanim | awk '/=> \//{print $3}' | xargs -r -I{} cp -v {} initramfs/lib/ || true
        ldd system/bin/installer_gui | awk '/=> \//{print $3}' | xargs -r -I{} cp -v {} initramfs/lib/ || true

        mkdir -p iso_root/boot
        (cd initramfs && find . | cpio -H newc -o) | gzip > iso_root/boot/initramfs.cpio.gz

    - name: Crear estructura ISO con GRUB EFI
      run: |
        mkdir -p iso_root/boot/grub
        cp system/boot/Image iso_root/boot/Image
        cat > iso_root/boot/grub/grub.cfg <<EOF
        set default=0
        set timeout=5
        menuentry "CultraCore ARM64" {
          linux /boot/Image root=/dev/ram0 rdinit=/init console=ttyAMA0
          initrd /boot/initramfs.cpio.gz
        }
        EOF

    - name: Crear imagen ISO ARM64
      run: |
        grub-mkrescue --output=cultracore_arm64.iso iso_root

    - name: Subir artefacto ISO
      uses: actions/upload-artifact@v4
      with:
        name: CultraCore-ARM64-ISO
        path: cultracore_arm64.iso
