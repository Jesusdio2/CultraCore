name: Build CultraCore PE ISO

on:
  workflow_dispatch:

jobs:
  build-x64:
    runs-on: ubuntu-latest

    steps:
    - name: Clonar CultraCore
      uses: actions/checkout@v3

    - name: Instalar dependencias
      run: |
        sudo apt update
        sudo apt install -y build-essential genisoimage libncurses-dev flex bison libssl-dev \
          libelf-dev cpio gzip curl syslinux-common libsdl2-dev busybox-static

    - name: Descargar bzImage desde Release
      run: |
        mkdir -p system/boot
        curl -L \
          https://github.com/Jesusdio2/CultraCore/releases/download/Dev1/bzImage \
          -o system/boot/bzImage

    - name: Compilar binarios (init, shell, bootanim, installer_gui)
      run: |
        mkdir -p system/bin
        # init del PE: estático para no depender de librerías
        gcc -static src/init.c -o system/bin/init
        # shell y bootanim pueden ser dinámicos; preferible estáticos en PE
        gcc -static src/shell.c -o system/bin/shell
        gcc -static src/bootanim.c -o system/bin/bootanim
        # installer_gui: intenta estático; si tu entorno no soporta SDL2 estático,
        # compílalo dinámico y copia sus librerías al initramfs (ver paso siguiente)
        gcc -static src/installer_gui.c -o system/bin/installer_gui -lSDL2 || \
          gcc src/installer_gui.c -o system/bin/installer_gui -lSDL2

    - name: Generar initramfs (PE con busybox)
      run: |
        # Estructura base
        mkdir -p initramfs/bin initramfs/sbin initramfs/etc
        mkdir -p initramfs/proc initramfs/sys initramfs/dev

        # Binarios propios
        cp system/bin/init initramfs/bin/init
        cp system/bin/shell initramfs/bin/shell
        cp system/bin/bootanim initramfs/bin/bootanim
        cp system/bin/installer_gui initramfs/bin/installer_gui
        chmod +x initramfs/bin/init

        # Busybox estático + symlinks de utilidades básicas
        cp /bin/busybox initramfs/bin/busybox
        ln -s /bin/busybox initramfs/bin/sh
        ln -s /bin/busybox initramfs/bin/mount
        ln -s /bin/busybox initramfs/bin/ls
        ln -s /bin/busybox initramfs/bin/mkdir
        ln -s /bin/busybox initramfs/bin/umount
        ln -s /bin/busybox initramfs/bin/echo
        ln -s /bin/busybox initramfs/bin/cat

        # Si installer_gui quedó dinámico, copiar librerías necesarias (SDL2)
        if ldd system/bin/installer_gui >/dev/null 2>&1; then
          mkdir -p initramfs/lib initramfs/lib64
          # Copiar dependencias reportadas por ldd
          ldd system/bin/installer_gui | awk '/=> \//{print $3}' | xargs -r -I{} cp -v {} initramfs/lib/ || true
          # Copiar SDL2 si está en rutas estándar
          for p in /usr/lib/x86_64-linux-gnu/libSDL2*.so* /usr/lib/libSDL2*.so*; do
            [ -f "$p" ] && cp -v "$p" initramfs/lib/ || true
          done
        fi

        # Empaquetar initramfs
        mkdir -p iso_root/boot
        (cd initramfs && find . | cpio -H newc -o) | gzip > iso_root/boot/initramfs.cpio.gz

    - name: Crear estructura ISO
      run: |
        cp system/boot/bzImage iso_root/boot/
        cat > iso_root/isolinux.cfg <<'CFG'
DEFAULT cultracore
LABEL cultracore
  KERNEL /boot/bzImage
  APPEND initrd=/boot/initramfs.cpio.gz init=/bin/init console=ttyS0 console=tty0 raid=noautodetect
CFG

    - name: Obtener isolinux.bin y ldlinux.c32
      run: |
        mkdir -p iso_root/isolinux
        curl -L http://archive.ubuntu.com/ubuntu/pool/universe/s/syslinux/isolinux_6.04~git20190206.bf6db5b4+dfsg1-3ubuntu3_all.deb -o isolinux.deb
        dpkg-deb -x isolinux.deb .
        cp ./usr/lib/ISOLINUX/isolinux.bin ./iso_root/isolinux/isolinux.bin
        cp /usr/lib/syslinux/modules/bios/ldlinux.c32 ./iso_root/isolinux/ldlinux.c32

    - name: Crear imagen ISO con kernel
      run: |
        genisoimage -o cultracore_pe_x64.iso \
          -b isolinux/isolinux.bin \
          -c isolinux/boot.cat \
          -no-emul-boot -boot-load-size 4 -boot-info-table \
          -iso-level 3 -J -R iso_root

    - name: Subir artefacto ISO
      uses: actions/upload-artifact@v4
      with:
        name: CultraCore-PE-x64-ISO
        path: cultracore_pe_x64.iso
